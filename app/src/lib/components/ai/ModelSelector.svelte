<script lang="ts">
  import { createEventDispatcher, onMount } from 'svelte';
  import type { AIModel } from '$lib/types';
  import { Bot, Settings, Key, CheckCircle2, XCircle } from 'lucide-svelte';
  import { fly } from 'svelte/transition';
  import { defaultModel } from '$lib/constants/models';
  import APIKeyInput from '$lib/components/common/keys/APIKeyInput.svelte';
  import { apiKey } from '$lib/stores/apiKeyStore';
  import { get } from 'svelte/store';
  import { providers, type ProviderType } from '$lib/constants/providers';
  import { modelStore } from '$lib/stores/modelStore';
  import { currentUser } from '$lib/pocketbase';

  let isOffline = false;
  modelStore.subscribe(state => {
    isOffline = state.isOffline;
  });
  
  export let selectedModel: AIModel = defaultModel;

  const dispatch = createEventDispatcher<{
    select: AIModel;
  }>();

  let currentProvider: ProviderType | null = null;
  let showAPIKeyInput = false;
  let availableProviderModels: Record<ProviderType, AIModel[]> = {
    openai: [],
    anthropic: [],
    google: [],
    grok: []
  };

  async function handleProviderClick(key: string) {
    const provider = key as ProviderType;
    const currentKey = get(apiKey)[provider];
    
    if (currentProvider === provider) {
      currentProvider = null;
      return;
    }
    
    currentProvider = provider;

    if (!currentKey) {
      showAPIKeyInput = true;
    } else {
      if ($currentUser) {
        try {
          await modelStore.setSelectedProvider($currentUser.id, provider);
          await loadProviderModels(provider);
          showAPIKeyInput = false;
        } catch (error) {
          console.warn('Error setting provider:', error);
        }
      }
    }
  }

  async function handleModelSelection(model: AIModel) {
    if ($currentUser) {
      try {
        const success = await modelStore.setSelectedModel($currentUser.id, model);
        if (success) {
          selectedModel = model;
        }
      } catch (error) {
        console.warn('Error selecting model:', error);
      }
    }
    dispatch('select', model);
  }

  async function loadProviderModels(provider: ProviderType) {
    const currentKey = get(apiKey)[provider];
    if (currentKey) {
      try {
        const providerModelList = await providers[provider].fetchModels(currentKey);
        availableProviderModels[provider] = providerModelList;
      } catch (error) {
        console.error(`Error fetching models for ${provider}:`, error);
      }
    }
  }

  async function handleAPIKeySubmit(event: CustomEvent<string>) {
    if (currentProvider) {
      await apiKey.setKey(currentProvider, event.detail);
      showAPIKeyInput = false;
      await loadProviderModels(currentProvider);
    }
  }
</script>

<div class="selector-container">
  <div class="providers-list">
    {#each Object.entries(providers) as [key, provider]}
      <div class="provider-item">
        <button 
          class="provider-button"
          class:provider-selected={currentProvider === key}
          on:click={() => handleProviderClick(key)}
        >
          <div class="provider-info">
            <img src={provider.icon} alt={provider.name} class="provider-icon" />
            <span class="provider-name">{provider.name}</span>
          </div>
          <div class="provider-status">
            {#if $apiKey[key]}
              <CheckCircle2 size={16} color="green" class="status-icon success" />
            {:else}
              <XCircle size={16} color="red" class="status-icon error" />
            {/if}
          </div>
        </button>
        
        {#if currentProvider === key && availableProviderModels[key].length > 0}
          <div class="model-list" in:fly={{ y: 10, duration: 200 }} out:fly={{ y: -10, duration: 200 }}>
            {#each availableProviderModels[key] as model}
              <button 
                class="model-button"
                class:model-selected={selectedModel.id === model.id}
                on:click={() => handleModelSelection(model)}
              >
                {model.name}
              </button>
            {/each}
          </div>
        {/if}
      </div>
    {/each}
  </div>

  {#if showAPIKeyInput}
    <APIKeyInput
      provider={currentProvider ?? ''}
      on:submit={handleAPIKeySubmit}
      on:close={() => showAPIKeyInput = false}
    />
  {/if}
</div>

{#if isOffline}
  <div class="offline-indicator">
    <XCircle size={16} color="orange" />
    <span>Offline</span>
  </div>
{/if}

<style lang="scss">
  @use "src/themes.scss" as *;

  * {
    font-family: var(--font-family);
  }

  .selector-container {
    width: 100%;
    max-width: 300px;
    // background: var(--bg-color);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
  }

  .providers-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .provider-item {
    width: 100%;
  }

  .provider-button {
    width: 90%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
    background: transparent;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-color);
    transition: all 0.2s ease;

    &:hover {
      background: var(--bg-hover);
    }

    &.provider-selected {
      background-color: #1d6bff;
      color: white;
    }
  }

  .provider-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .provider-icon {
    width: 24px;
    height: 24px;
  }

  .provider-name {
    font-size: 16px;
  }

  .model-list {
    position: relative;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    margin-top: var(--spacing-xs);
    padding: var(--spacing-sm);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    background: var(--bg-gradient-right);
    border-radius: var(--radius-m);
    max-height: 300px;
    overflow-y: auto;
    backdrop-filter: blur(10px);
  }

  .model-button {
    padding: var(--spacing-sm);
    background: var(--bg-alt);
    border: none;
    border-radius: var(--radius-md);
    color: var(--text-color);
    font-size: 14px;
    transition: all 0.2s ease;
    z-index: 1000;

    &:hover {
      background: var(--bg-hover);
      color: white;
    }

    &.model-selected {
      background-color: #1dff1d;
      color: white;
    }
  }

  .offline-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.5rem;
    background-color: rgba(255, 165, 0, 0.1);
    border-radius: 4px;
    font-size: 0.75rem;
    color: orange;
  }

  .provider-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .status-icon {
    &.success { color: var(--success-color); }
    &.error { color: var(--error-color); }
  }
</style>